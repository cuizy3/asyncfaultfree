%4/4 changes, made general edits and changed (s_i,s_j) \in T to T(s_i,s_j)
%changed all the S_w to S, w_i w_j to s_i s_j, w to v, k l to v w
%4/10 incorporated new sugestions, also what 103 suggested

\documentclass{article}
\usepackage{amsfonts}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}

\title{Proof for normal operation of the duplicated scheme for asynchronous circuits}
\author{Zoey Zhou}
\date{\today}  
\usepackage{graphicx}
\graphicspath{ {c:/Desktop/} }

\usepackage{amsthm}
\newtheorem*{definition}{Definition}
\newtheorem*{claim}{Claim}
\newtheorem*{theorem}{Theorem}
\newtheorem*{corollary}{Corollary}
\newtheorem*{lemma}{Lemma}
 
\begin{document}
\section{Normal operation analysis}
Definitions:  
\begin{definition}A state graph consists of <V, S, T> where $V$ is the set of finite signals $v_1 .. v_n$.  $S$ is the function $S: V \to \{0,1\}$ %<-this might not be right math... and s(k) denotes the (binary) value of the state at signal $v_k$.  
which maps each variable to a boolean, an element of $S$ is called a state. $T$ is the set of all transitions in the state graph and $T \subseteq S \times S$.  \end{definition}

A transition has the additional constraint that only one signal is allowed to change between the two states in the transition.
\begin{definition}A transition $T(s_i, s_j)$ denotes a transition from the state $s_i$ to $s_j$.  Then there exists a signal $w$ such that $s_i(w)\neq s_j(w)$ and for any other signal $u$ where $u \neq w$ such that $s_i(u)=s_j(u)$ . 
\end{definition}

%major revision needed
State graphs can be implemented as an asynchronous circuit where the signals of a state graph $V$ maps one-to-one to wires in the circuit. %(one to one mapping?)  
Then the set of states $S$ can also describe the state of wires of the circuit.  The circuit has a set of transitions.  A transition of the circuit from a state $s_i \in S$, to a state $s_j \in S$ exists if and only if $T(s_i, s_j)$.%set of transitions instead of transitions
\begin{definition}A wire $u$ in the circuit is \textbf{excited} in state $s_i$ if there exists a $s_j$ such that $T(s_i,s_j)$ and $s_i(u) \neq s_j(u)$.  Alternatively if one treats the output of wire $u$ as a function of the current state $s_i$, then $f(s_i)\neq s_i(u)$\end{definition}
%(may need to change this definition to s'=/=s) <- added in

Semi-modularity means once a wire is excited, it stays excited until it transitions to the excited value.  Circuits that are semi-modular are also speed independent.  Formally this can be defined as follows:
\begin{definition}An asynchronous circuit is \textbf{semi-modular} if for every $s_i$ and $s_j$ such that $T(s_i,s_j)$ holds, and let $u$ and $w$ be wires such that $s_i(u) \neq s_j(u)$ and $w\neq u$, then if $s_i(w)$ is excited, $s_j(w)$ is also excited \end{definition}

\begin{definition} \textbf{Trace} $\sigma$ of a circuit is a sequence of states of infinite length where $\sigma_i$ is the $i^{th}$ term of the sequence.  $\sigma: \mathbb{N} \to S$ and $T(\sigma_i,\sigma_{i+1})$ for $\forall i \in \mathbb{N}$\end{definition} 
% all states or just the state graph ones

\begin{definition} Two circuits A and B are \textbf{equivalent} if the set of all traces from circuit A and circuit B are equal $\{\sigma^A |\sigma^A$ is a possible trace in $A\}=\{\sigma^B |\sigma^B$ is a possible trace in $B\}$.
\end{definition}
%good enough for now, do I need if and only if?

An additional property of the asynchronous circuit is that one can view each wire as a separate black box.  For a wire $w$, inputs from the rest of the circuit ($I_w$ and $I_w \subseteq$ V) feed into a gate and outputs the wire value $w$.  We call the instantaneous value of the gate for $w$ of a state $s$ as $f_w(s|_I)$, where f is the function $f:[I \to \{0,1\}] \to \{0,1\}$ and $s|_I$ is the state $s$ projected on the input variables $I_w$.  If inputs to the gate remain constant, the output $w$ will eventually take the value specified by $f_w(s|_I)$  %maybe change w again, also the f(s) vs f(I) thing...
\newline

We assume that the circuit is implemented either as generalized C-element or standard C-implementation.  This is reasonable because all state transition diagrams satisfying some properties can be implemented as these standards.  We transform the circuit by making a duplicated copy of the set and reset gates to each wire and change the C-element that takes set and reset as inputs, to a 4-input C-element which takes both copies of set and reset as inputs.  Note that the output of a 4-input C-element only transitions to 1 when both copies of set are high and reset are low and vice versa for transitions to 0.  The output of the two 4-input C-elements are connected to three layers of c-elements.  We label the duplicated circuit halves as circuit A and circuit B.  Then for each wire $w$ we add in intermediate wires $c1^A$, $c2^A$, $c3^A$ and $c1^B$, $c2^B$, $c3^B$ for circuits A and B respectively.  In the first layer of C-elements, $c1^A$ and $c1^B$ are outputs of the 4-input C-elements and are inputs to two C-elements producing $c2^A$ and $c2^B$.  These are then the inputs to the second layer of C-elements producing $c3^A$ and $c3^B$.  These are then the inputs to the third layer of C-elements.  We can (arbitrarily) label one of the final C-element outputs as $w^A$ and the other output as $w^B$.  These then connect to other gates in circuit A and circuit B respectively.  (Note that the outputs of the C-elements can be arbitrarily named and connected to the next gates, and the next gates can also be arbitrarily named $A$ or $B$ as long as it does not create any inconsistencies in the naming convention, ie. all $A$ wires feed into the $A$ gates) %possibly expand on this and also show why such a naming can always occur?
\newline
\begin{figure}
  \centering
    \includegraphics[width=\textwidth]{gatew4c2}
  \caption{Transformed circuit after duplication and adding C-elements.}
\end{figure}

Because the transformed circuit has some extra wires, we want to define a correspondence to be able to compare between the wires of the original circuit and that of the duplicated circuit halves.  For the duplicated circuit, a combined state is the pairing of the state of circuit A and the state of circuit B. It has six times the number of wires for each output wire in the original circuit.  The state graph for a duplicated circuit is defined on this combined state.  We define the half-circuit mapping $h^A: s^{full} \to s^A$ where $s^{full}$ is the combined state of a duplicated circuit and $s^A$ are made up of the wires $w^A$ that correspond to the original wires $w$.  The half-circuit mapping $h^B$ is similarly defined to map to $s^B$.  Note that the $h(\sigma)$ mappings are overloaded for a trace, where it outputs a mapped state for each of the states in a trace.%not sure if I want the mapping to be from variable to variable or specific state to state
For a trace in the duplicated circuit we project the full states onto a shortened list of wires (ie the wires corresponding to the original circuit). The resulting trace may have successive repeated states and we delete the repeats to obtain a valid trace on the shortened wires.  %do I need to define all the new transitions in duplicated circuit?  maybe
\newline
We want to show this circuit behaves similar to the original circuit under normal operation.  In other words we want to prove that after applying either mapping of $h^A$ or $h^B$, the resultant circuit and the original circuit are equivalent.  We start by first proving the following lemma.

\begin{definition} A \textbf{valid initial state} in half of a duplicated circuit is defined as follows.  Given any initial state in the original circuit $s \in S$, for each wire $w$ assign corresponding wires in the half duplicated circuit that value $c1^A=c2^A=c3^A=w^A=w$.
\end{definition}

\begin{lemma}[1]
Let $\sigma_n$ be the sequence of the first n states of a trace $\sigma$ (possibly finite).  In the duplicated circuit, for a half circuit $A$ or $B$, if a trace $\sigma$ starts from a valid initial state in that half circuit (and the wires on the other half are strictly 0 or 1, and transitions from excited gates also only produce 0 or 1 and no in between values, no matter the duration of incoming signals), then $h^{A,B}(\sigma_n)$ is a prefix of a trace of the original circuit.

%In the duplicated circuit, for all traces $\{\sigma\}$ that starts from a valid initial state for half of the circuit ${A,B}$, the following is true.  At each state $s_n$ in the trace mapped to $h^{A,B}(s_n)$ in the original circuit, a wire $w$ is excited if and only if exactly one of the following is true: the gate is excited or $x'^{A,B}\neq x^{A,B}$ or $x^{A,B}\neq w^{A,B}$.  (So for a wire that is not excited in the original circuit, neither the gates or the c-element is excited in the duplicated circuit.)
%need to modify to include two layer c-elements

%If the duplicated circuit is in state $s_n$ and the original circuit is in state $h^A(s_n)$, and for all wires $w$ that are excited in this state $f_w(s_n|_I)\neq w$ in original circuit, then $f_w(s_n|_I) \neq x^A$ or $x^A \neq w^A$ in duplicated circuit (exactly one of these is true).  
%In addition, if wire $w$ is not excited in the original circuit $f_w(s_n|_I)=w$, then in the duplicated circuit half $f_w(s_n|_I)=x^A=w^A$.  
\end{lemma}
\begin{proof}
Without loss of generality we prove that this property holds for the A half of the circuit, the same reasoning then extends to the B half of the circuit.  We prove this lemma by induction.  The induction hypothesis is \textbf{at $n^{th}$ state of the trace $s_n$, $h^A(s_n)$ is a state of the original circuit and either $h^A(s_n)=h^A(s_{n+1})$ or $T(h^A(s_n), h^A(s_{n+1}))$.  Additionally a wire $w$ in $h^A(s_n)$ is excited if and only if exactly one of the following is true: the set or reset gate corresponding to $w$ is excited or $f(set^A, reset^A) \neq c1^A$ or $c1^{A}\neq c2^{A}$ or $c2^{A}\neq c3^{A}$ or $c3^{A} \neq w^A$. } (If a wire $w$ is not excited then the previous cannot be true.)  
\newline
The base case is constructed as follows:  by definition of valid initial state we have that $c1^A=c2^A=c3^A=w^A=w$ for some state in the original circuit.  This is the A half of $s_0$ in the duplicated circuit.  The only possible transitions are on the set and reset of wires that are excited in the original circuit and it is simple to see that this initial state satisfies the induction hypothesis.   \newline
The induction step is for some $\sigma$ that is a trace in the duplicated circuit and $k < length(\sigma)$, assume that the lemma property is true for $s_k$, the $k^{th}$ state in the trace.  We will prove that the property is also true for state $s_{k+1}$.  \newline
For state $s_k$, we look at all possible transitions; a transition may only occur on excited gates or c-elements.  From the induction hypothesis, the set or reset gates are excited or $f(set^A, reset^A) \neq c1^A$ or $c1^{A}\neq c2^{A}$ or $c2^{A,B}\neq c3^{A}$ or $c3^{A} \neq w^A$ if and only if $w$ is excited in $h^A(s_k)$.  In the first case when the set and reset gate is excited and a transition occurs, then $f(set^A, reset^A)\neq w$ and since $w=w^A=c1^A$ then $f(set^A, reset^A)\neq c1^A$.  Additionally the set and reset gate is no longer excited.  No transitions occurred on the other variables so $c1^A=c2^A=c3^A=w^A$ is still true.  Since the transition occured on an intermediate wire then $h^A(s_k)=h^A(s_{k+1})$.  Therefore the set of excited wires in $h^A(s_{k+1})$ does not change and for excited wires $v$ where $v\neq w$ the induction property holds for $s_k$ and thus must also hold for $s_{k+1}$. \newline
In the second case when $f(set^A, reset^A)\neq c1^A$, and $c1^A$ transitions, then in $s_{k+1}$, $c1^A\neq c2^A$ and $f(set^A, reset^A)= c1^A$, which makes exactly one of the list of statements true again.  Since the transition occured on an intermediate wire then $h^A(s_k)=h^A(s_{k+1})$.  Therefore the set of excited wires in $h^A(s_{k+1})$ does not change and for excited wires $v$ where $v\neq w$ the induction property holds for $s_k$ and thus must also hold for $s_{k+1}$. %don't know if this needs to be explained more (and add that the non-excited wires are still non-excited?)
%since the inputs to the gate and the intermediate wires did not transition, then the gate is excited or $y^{A,B}\neq v^{A,B}$.  
%do I need to show that non-excited has nothing excited in duplicated
%$w$ is still excited in $h^A(s_{k+1})$ and in state $s_{k+1}$ only $c1^{A}\neq c2^{A}$ is true.   Therefore in this case the property is true for state $s_{k+1}$
\newline
For the third case when $c1^{A}\neq c2^{A}$ and $c2^A$ transitions.  Then in state $s_{k+1}$, $c1^A=c2^A$ and $c2^{A}\neq c3^{A}$ and $c3^{A}=w^A$ and the gate remains unexcited since $h^A(s_k)=h^A(s_{k+1})$.  By similar reasoning to the first case, the induction property holds for all other wires as well and thus it holds for $s_{k+1}$. \newline
For the fourth case when $c2^A \neq c3^A$ and $c3^A$ transitions.   Then in state $s_{k+1}$, $c1^A=c2^A$ and $c2^{A}= c3^{A}$ and $c3^{A}\neq w^A$ and the gate remains unexcited since $h^A(s_n)=h^A(s_{n+1})$.  The induction property holds for all other wires as well and thus it holds for $s_{k+1}$. \newline
For the fifth case when $c3^A\neq w^A$ and $w^A$ transitions.  Since w is excited in $h^A(s_k)$, then $T(h^A(s_k), h^A(s_{k+1}))$.  For any excited wire $v$ in state $h^A(s_k)$ and $v\neq w$, by semi-modularity $v$ is excited in state $h^A(s_{k+1})$ as well.  The state of the wires in $s_{k+1}$ corresponding to $v$ stays the same and the induction property holds for those wires in the duplicated circuit.  For all newly excited wires $u$ in $h^A(s_{k+1})$, that is not excited in $h^A(s_k)$ (or $w$ if we allow an immediate excitation in the other direction), then in $s_{k+1}$, $f(set^A, reset^A)=c1^A=c2^A=c3^A=u^A$ but the set and/or reset gate is excited.  Therefore the induction property holds in this case as well.  So the property holds for all possible $s_{k+1}$ and the induction step is complete. \newline
By induction, for any state $s_n$ in a trace $\sigma$, a wire $w$ is excited at state $h^{A,B}(s_n)$ in the original circuit if and only if exactly one of the following, the set or reset gates are excited or $f(set^A, reset^A) \neq c1^A$ or $c1^{A}\neq c2^{A}$ or $c2^{A,B}\neq c3^{A}$ or $c3^{A} \neq w^A$ in the duplicated half is satisfied.  Also $h^A(s_n)$ is a valid state in the original circuit and either $h^A(s_n)=h^A(s_{n+1})$ or $T(h^A(s_n), h^A(s_{n+1}))$.  This last property shows that $h^{A,B}(\sigma_n)$ is the prefix of a trace from the original circuit.
%do I need to show the opposite?  At every step the previous transitions are possible??  Dunno if true for faults though.... also something about collapsed states can't tell the difference?  Can we just map it to a circuit where everything goes together? <- this needs proving?

%so technically one exception is the original w.... but w sort of counts in newly excited if it is indeed newly excited  
%need to expand on newly excited wires
%do I need to define transitions as it occurs here?

%prove each half separately
\end{proof}
Note that the previous proof does not place any requirements on the other half of the circuit other than for the signals to be 0 or 1.  Thus this lemma is true regardless of whether there is a fault or not in the other half of the circuit.  It guarantees that if there is a next state it must follow the state transitions of the original circuit, but does not guarantee that there will be a next state.  Next we will show that if both halves of the circuit start at the same valid initial state, deadlock does not occur.

\begin{figure}
  \centering
    \includegraphics{flowl2}
  \caption{The wires in each row are in order of 4C-element, C1, C2, C3, W.  Each row represents half of the duplicated circuit, ie. top row are A half wires and bottom row are B half wires.  'Un' denotes that the 4C element is unexcited and 'Exc' denotes the 4C element is excited.  }
\end{figure}

\begin{lemma}[2]
For all traces $\sigma$ in the duplicated circuit where both circuit halves start in the same valid initial state, deadlock does not occur.
\end{lemma}
\begin{proof}
We first show that if the duplicated circuit starts in the same valid initial state, for each wire block, it will be in one of the states in the above figure.  The figure halves the number of cases, after case 10 the circuit will repeat as from case 1 except with the 0's and 1's inverted.  However it behaves the same way to excite or unexcite the C-element it feeds into and thus we only need to analyze the first 10 states.  \newline
We prove this property by induction.  We look at the base case of $c1^A=c2^A=c3^A=w^A=c1^B=c2^B=c3^B=w^B=w$ for every wire $w$ in the original circuit.  A wire $w$ can be either excited or unexcited in the original circuit. If the original wire $w$ is unexcited this corresponds to case 1 (or case 10 by inverting the 1's or 0's which we will here on ignore, but each case technically represents two states).  If $w$ is excited then this is case 2.  Thus this property is true for the base case. \newline

In the induction step, I assume that this property is true for state $s_n$ and show it is true for $s_{n+1}$.  \newline
We examine all possible next transitions by enumerating all the possible cases and within each case all possible transitions on each wire. \newline
Case 1:  All c1, c2, c3 and w wires are unexcited and cannot transition.  Only possible transition is when the 4 input C-element becomes excited.  Since the two 4 input C-elements have the same inputs, they will be excited together, that is $s_{n+1}$ is case 2.\newline
Case 2:  We first note that excited 4C-elements cannot become unexcited (and all other wires do not change).  By contradiction, assume that one of the 4C-elements is unexcited in $s_{n+1}$ with no changes on the other wires.  We see that this violates lemma 1 since at $s_n$, both sides are excited in $w$ but at $s_n$ one side is not excited in $w$ but $w^{A,B}$ has not changed.  In state $s_n$, $c2$ $c3$ $w$ are not excited and cannot transition.  Thus the only excited wires $c1^{A,B}$ can transition so $s_{n+1}$ is either case 3a or 3b. \newline
Case 3a/3b:  By the same argument as case 2, we note that the excited 4C-element cannot become unexcited (and all other wires do not change).  Also the unexcited 4C-element cannot become excited because if that happened it will be in a next state that violates lemma 1 as well.  Again, in state $s_n$, $c2$ $c3$ $w$ are not excited and cannot transition.  Thus the only excited wire $c1^{A}$ or $c1^{B}$ can transition so $s_{n+1}$ is case 4. \newline
Cases 4/6/8:  These cases can be analyzed together.  By the same argument above, the unexcited 4C-elements cannot become excited because both halves are already excited in state $s_n$, if a 4C-element becomes excited it will be in a next state that violates lemma 1.  In case 4 only $c2^{A,B}$ are excited, case 6 only $c3^{A,B}$ are excited and case 8 only $w^{A,B}$ are excited.  All other wires are not excited.  Thus those are the only wires that can transition in each of the cases and the next states are case 4-> case 5a, 5b, case 6-> case 7a, 7b and case 8-> case 9a, 9b
\newline
Cases 5a/5b/7a/7b/9a/9b:  These cases can also be analyzed together.  Again we note that the unexcited 4C-elements cannot become excited, otherwise it would violate lemma 1.  In each case only one C-element output is excited and thus the only possible transition.  The next states are case 5a, 5b->case 6, case 7a, 7b-> case 8, and case 9a, 9b-> case 10.
\newline
Since all cases result in a next state in the figure, the induction step is complete. \newline

To show that deadlock does not occur, we show that in any state $s_n$ from a trace that starts in a valid initial state there always exists an excited wire.  $s_n$ must follow the above property for every wire.   The circuit can be in two states, for every wire block $w$, either all wires in the A half and B half are equal that is $w^A=w^B$, or there exists some wire $v$ such that $v^A\neq v^B$.  In the first case, if every output wire pair are equal, then $h^A(s_n)=h^B(s_n)$ and in every reachable state there exists an excited wire $u$ in the original circuit.  By lemma 1 both halves of the duplicated circuit for $u$ is excited.  Then the circuit must be in case 2-9 for $u$.  In each of these cases at least one wire is excited.  \newline
In the second case, for some wire $v$ such that $v^A\neq v^B$, then $v$ is in case 9a or 9b and there is also an excited wire, either $v^A$ or $v^B$.  Since for all of the cases there are next transitions, there is no deadlock.
\end{proof}


Combining the results of the two lemmas yield the following result:
\begin{theorem}[1]
For all traces $\sigma$ in the duplicated circuit starting from a valid initial states, if $\sigma$ is a trace in the duplicated circuit and $\sigma_n$ is the sequence of the first n states of $\sigma$, then $h^{A,B}(\sigma_n)$ is a prefix of a trace in the original circuit for all $n \in \mathbb{N}$.  (h might make the trace shorter, so the prefix will not be of length n)
\end{theorem}

%with these 3 properties show the original claim
\section{Single transient error analysis}
\begin{definition}A transient error on a wire $x$ can happen so that from the start of the transient error $x=/~x^{init}$.  Once the transient passes, two things can occur, it can return to the previous value $x=x^{init}$ or if during the transient error the gate before it becomes excited and transitions, then it remains at that value and is effectively an early transition. %do I need to talk about when transient is not ~x?  ie hold same value?  That's the same as a longer delay
\end{definition}
Next we will show that adding a single transient error to any wire will still allow one of the half circuits to progress as normal.  We split the wires into two sets based on their properties when a single transient error is added.  Lemma 3 shows that if a single error is added to $c1$, $c2$ or $c3$ wires, the output wires still follow the original state graph.  Lemma 4 shows that if a single error is added to any of the other wires, then the $c1$, $c2$, $c3$ wires follow a similar order to the non-fault case and thus the output wires can never be in a deadlocked state because the 'saved' states earlier in the c-element chain will rescue the circuit from deadlock.
\begin{lemma}[3]
For all traces $\sigma$ in the duplicated circuit where both circuit halves start in the same valid initial state, after adding a transient error to the $c1$, $c2$ or $c3$ wire, $h^{A,B}(\sigma_n)$ is a prefix of a trace in the original circuit for all $n \in \mathbb{N}$.
\end{lemma}
\begin{proof}
Without loss of generality we can show this is true if a transient error occurs in $A$ half.  %We first deal with the $0\to 1 \to 0$ error on $c2^A$.  
We first examine when there is a transient on $c2^A$.  We look at two cases.  One is when $w^A$ and $w^B$ do not change until after the transient effects pass, we call this case A.  The other is when $w^A$ and $w^B$ do change while a transient is present, we call this case B. \newline
\begin{center}
\includegraphics[width=0.75 \textwidth]{lemma3cases}
\end{center} \newline
We examine the combinations of all possible states just before a transient occurs.  In particular we look at the $c2^A$, $c2^B$, $c3^A$ and $c3^B$ values.  We claim that if in the current state $c2^A \neq c2^B$ and $c2^A \neq c3^A$, or if $c2^A=c2^B$ and $c2^A\neq c3^A$ or $c2^B\neq c3^B$ or both (all other cases), this results in case A.  Intuitively this is because a transient on $c2^A$ will cause $c3^A$ or $c3^B$ to go from excited to non excited and $w^A$ and $w^B$ cannot change until the transient passes.  We also claim that if in the current state $c2^A \neq c2^B$ and $c2^A=c3^A$, or if $c2^A=c2^B$ and $c2^A=c3^A$ and $c2^B=c3^B$, this results in case B. \newline
Next we show that this is true in the following proof.  First we examine the two possibilities in case A.  In the first sub case, if $c2^A \neq c2^B$ and $c2^A \neq c3^A$ then by lemma 2 we have $c1^B\neq c2^B$.
 In state $s_n$ $c2^A$ experiences a transient then in state $s_{n+1}$, $c2^A=c2^B$ and $c2^A=c3^A$.  Only $c2^B$ is excited.  If $c2^B$ does not transition, $w^A$ and $w^B$ cannot change and by semi-modularity the logic gates to these wires cannot be excited or transition. The local circuit will stay in this state until the transient fault passes and the circuit returns to its state before the transient.  Otherwise if $c2^B$ transitions then we have $c2^A\neq c2^B$ and $c2^B \neq c3^B$ which is part of the next case we will analyze.
In the second subcase if a transition happens when $c2^A=c2^B$ and $c2^A\neq c3^A$ or $c2^B\neq c3^B$ (or both) then in state $s_{n+1}$, $c2^A\neq c2^B$ and $c2^A\neq c3^A$ or $c2^B\neq c3^B$ and there are no excitations in the local circuit.  Again $w^A$ and $w^B$ cannot change and by semi-modularity the logic gates to these wires cannot be excited or transition.  Then the local circuit will stay in this state until the transient fault passes and the circuit returns to its state before the transient. \newline
Next we look at the two possibilities in case B.  If in the current state $c2^A\neq c2^B$ and $c2^A= c3^A$, that is $c2^B\neq c3^B$, after the transient on $c2^A$, $c3^{A,B}$ will become excited.  Since $c1^B=c1^A$ then the transient on $c2^A$ is an early transition.  However the overall state of the circuit is exactly as if $c2^A$ transitioned correctly but early.  If at any time the transient passes, either the new value has propagated past $c3^{A,B}$ or it has not.  If it has not, there are no transitions available in the local circuit except $c2^A$, so eventually it will transition and the circuit will return to normal.  If the new value has propagated past $c3^{A,B}$, $c2^A$ does not have an effect, other than when eventually $c2^B$ changes again. Since $c2^A$ must eventually return to its previous value, the new value of $c2^B$ it returns to normal.  If $c2^A$ returns to its previous value earlier then it is a similar argument to the beginning of this case and the circuit will also return to normal.
Finally if in the current state $c2^A=c2^B$ and $c2^A=c3^A$ and $c2^B=c3^B$, a transient fault on $c2^A$ does not affect the excitations of the local circuit.  Then either the transient will pass and have no effect or the circuit can arrive at the previous case $c2^A\neq c2^B$ and $c2^A= c3^A$.  In either case the transient will have no effect on $h^{A,B}(\sigma_n)$.
%c3
A similar reasoning would then apply if a transient error occurs in $c1^A$, $c3^A$, and also for the $B$ half.  
\end{proof}

\includegraphics[width=\textwidth]{gatew4c}\newline
\begin{figure}
  \centering
    \includegraphics{flowl4}
  \caption{The wires in each row are in order of C1, C2, C3.  Each row represents half of the duplicated circuit, ie. top row are A half wires and bottom row are B half wires.  Note that case 7 transitions according to case 1 except with the 0's and 1's inverted.  The following states mimic state 2-6 until it transitions back to state 1.}
\end{figure}

\begin{lemma}[4]
For all states $s_n$ from a trace $\sigma$ in the duplicated circuit where both circuit halves start in the same valid initial state, after adding a fault to any wire other than $c1$, $c2$ or $c3$, the following property is true.  If a transition is available on the $c1$ $c2$ and $c3$ wires, it transitions according to Figure.
\end{lemma}
\begin{proof}
Without loss of generality we prove this is true when a fault occurs in the A half.  The same reasoning applies when a fault occurs in the B half.  The property we want to show by induction is that at any state $s_n$ in the trace $\sigma$, for every wire $w$ where the fault is not in $c1$, $c2$ or $c3$, the $c1$, $c2$ and $c3$ variables follow the state transitions in the figure.  Again we only analyze for cases 1-6 as 7 on behave identically to cases 1-6 except with the 0's and 1's flipped.\newline
The base case is when no transient occurs, under normal operation these wires will always be in a state in the state transition diagram by lemma 2. \newline
In the induction step we assume $s_k$ is a state in the state transition diagram for a wire $w$, then at $s_{k+1}$ we look at the possible next states.  \newline
Case 1:  There are no faults on $c1$ or $c2$ and thus $c2$ and $c3$ cannot be excited.  $c1$ can be excited depending on the inputs to the 4 input C-element.  Therefore, if there is a transition from this state it must be to case 2a or 2b.\newline
Case 2a/2b:  Again, since there are no faults on $c1$ or $c2$ then $c2$ and $c3$ cannot be excited.  And $c1$ cannot be excited to 0 because $w$ is in an excited to 1 state and if $c1$ is excited to 0 that would contradict lemma 1 as $w^b$ cannot change.\newline
%I might need to show the excited ness of the good 4C gate
Cases 3-6:  $c1$ cannot be excited 0 due to the same reasoning above as it would contradict lemma 1.  The only possible transitions are on the $c2$ and $c3$ wires and since there are no faults on them they must transition according to the figure.
\newline
By induction, we property we set out to prove is true, if there is a transition possible, it transitions according to the non-fault case.
\end{proof}
A corollary of this is that only one of $c1$ $c2$ or $c3$ pairs can be mismatched.  And thus with any faults that is not at $c1$ $c2$ or $c3$, the output pair at deadlock must be equal.

\begin{theorem}[2]
With the addition of a single transient error, starting from all valid initial states in the original circuit (and a predefined correspondence in the duplicated circuit) and for all $n \in \mathbb{N}$, if $\sigma$ is a trace in the duplicated circuit and $\sigma_n$ is the sequence of the first n states of $\sigma$, then one of $h^{A,B}(\sigma_n)$ (the non faulty half) is a prefix of a trace in the original circuit.  And the circuit does not deadlock.  
\end{theorem}
\begin{proof}
Without loss of generality we can assume the fault occurs in the A half of the circuit. 
A deadlocked circuit in my scheme must have the property that at least one pair of output wires are different.  That is $w^A\neq w^B$ for some wire $w$.
This is shown by contradiction.  Assume that the circuit is deadlocked and $w^A = w^B$ for all wires $w$ from the original circuit.  If a transient occurs, one can wait until its effect passes.  There
 must be a wire that is excited in the original circuit and we look at that wire in the duplicated circuit. By lemma 4, we look at the 3 cases if $c2^A=c2^B$ and $c3^A=c3^B$, or if $c2^A\neq c2^B$ or if $c3^A\neq c3^B$ is true.  \newline
In the first case of $c2^A=c2^B$ and $c3^A=c3^B$, we look at the four possibilities from lemma 1.  If $c3^B\neq w^B$, then $w^B$ can transition.  If $c2^B\neq c3^B$ then $c3^B$ can transition.  If $c1^B\neq c2^B$ then it depends on $c1^A$.  If $c1^A=c1^B$ then $c2^B$ can transition.  If $c1^A\neq c1^B$, then the gate logic in A half must be excited since the inputs to the gate for A and B are the same.  And if the gate for B is excited a transition can also occur.  Thus next transitions are always possible in this case.\newline
The second case is  $c2^A\neq c2^B$ and $c3^A=c3^B$.  Again it depends on $c1^A$.  If $c1^A=c1^B$, then one of $c2^{A,B}$ can transition.  If $c1^A\neq c1^B$ then we use lemma 4 where either $c1^B \neq c2^B$ or $c2^B \neq c3^B$ and the gate logic in B half has already transitioned.  So the gate logic in A half must be excited since the inputs to the gate for A and B are the same and a next transition is possible.\newline
The third case is  $c3^A\neq c3^B$ and $c2^A=c2^B$.  Then one of $c3{A,B}$ can transition.\newline
Thus a transition can always occur and the circuit is not deadlocked which leads to the contradiction.  Thus at least one pair of output wires must be different to have a deadlock. To remain deadlocked, it must be true that for such a wire $w^A\neq w^B$ and $c1^A\neq c1^B$ and $c2^A\neq c2^B$ and $c3^A\neq c3^B$.  But we have shown in lemma 4 that $c2^A\neq c2^B$ and $c3^A\neq c3^B$ cannot occur at the same time in our circuit under a single transient fault. Thus deadlock is not possible.  And applying lemma 1 $h^B(\sigma_n)$ is a prefix of a trace in the original circuit. 
\end{proof}

\section{Single permanent fault}
A single stuck at fault is when a wire is stuck at either the value 0 or 1 permanently.  To develop a way to rescue the circuit when these kinds of fault occurs, we first analyze the state of the duplicated circuit.  We split into 5 different cases.  1. when an output w wire is stuck; 2. when c2 is stuck; 3. when c3 is stuck; 4 when c1 is stuck; 5 when a wire within the gate logic is stuck.  First we note that lemma 3 and 4 applies in the permanent fault case, lemma 3 because permanent error is a subcase of transient errors under those conditions.  And lemma 4 because we made no assumptions about what kind of fault it is.  For permanent faults, if no deadlocks occur then the 'good' half of the circuit will proceed as normal according to Lemma 1.  \newline
Claim 1: When deadlocks occur under case 1, the only mismatched output wires are the pair with the fault.  In addition the $c3$ wires before the fault must be equal and equal to the 'good' value on the fault pair.  The only other wires with faulty values are the ones the w wire feeds into.
\begin{proof}
When deadlocks occur under case 1, output wire has a permanent fault: due to lemma 4 it must be in a state where all other pairs of output wires are equal with the exception of the fault pair.  Also from lemma 4, either c2 or c3 pairs are mismatched.  If c2 is mismatched then c3 is equal. If c2 is equal and c3 is mismatched c3 is excited and not at deadlock.  Thus all c3 pairs are equal.   However it may be possible for c1, to be mismatched for downstream logic gates of the faulty wire.
\end{proof}
Claim 2: When deadlocks occur under case 2, $c2$ has a permanent fault, the only mismatched wires are the $c2$ pair with the fault and possibly the downstream $c3$ pair.
\begin{proof}
Under case 2, applying lemma 3 to the fault pair and lemma 4 to the other wires, all pairs of outputs are equal.  Since A half output wire values are equal to B half output wires, and B half is the assumed 'good' half then both halfs are in a valid state.  Also according to lemma 4, if any of the c1, c2, c3 pairs are mismatched this implies the 'good' half is excited and since the inputs to both sides are the same then both halves are excited.  This contradicts the initial mismatched assumption since this is a deadlock state, thus all c1 pairs are equal.  Then all c2 pairs with exception of the fault pair are equal.  And similarly all c3 pairs are equal with the exception of (possibly) that downstream of the fault pair. \newline
\end{proof}
Claim 3:  When deadlocks occur under case 3, $c3$ has a permanent fault, the only mismatched wires are the $c2$ pair with the fault and possibly the downstream output wire pair.
\begin{proof}
Under case 3, again we apply lemma 3 to the fault pair and lemma 4 to the other wires.  All other pairs of output wires, with the exception of the ones downstream of the fault pair must be equal due to lemma 4.  If the output wires are mismatched then it is possible for downstream c1 to be mismatched as well.  Also from lemma 4, either c2 or c3 pairs are mismatched, and with the same reasoning as in case 1 all c3 pairs are equal.  If the output wires are not mismatched then all c1 pairs are equal and subsequently all c2 pairs.  Then all other c3 pairs are equal the only mismatched c3 is the faulty pair. \newline
\end{proof}
Claim 4:  When deadlock occurs under case 4, $c1$ has a permanent fault, the only mismatched wires are the $c1$ pair with the fault and possibly the downstream $c2$ pair.
\begin{proof}
Under case 4, when c1 has a permanent fault, again at deadlock all output wires are equal due to lemma 3 for the wires corresponding to the fault pair and lemma 4 for all other output wire pairs.  Thus each half of the circuit is at a valid state.  Suppose there exists a c1, c2, or c3 pair of mismatched wires (does not have a fault pair).  This implies the 'good' half is excited and since the inputs to both sides are the same then both halves are excited.  This contradicts the initial mismatched assumption since this is a deadlock state, thus all c1 pairs are equal (with the exception of the fault pair).  Then all c2 pairs with exception of that downstream of the fault pair are equal.  All c3 pairs are equal as well. \newline
\end{proof}
Claim 5:  When deadlock occurs under case 5, if a set or reset wire has a permanent fault, then the only inconsistent set and reset pairs are in the wire with the permanent fault.  With possibly mismatched downstream $c1$ of the permanent fault.
\begin{proof}
Under case 5, when a set or reset wire has a permanent fault, again at deadlock all output wires are equal due to lemma 4.  Thus each half of the circuit is at a valid state.  Since the set and reset logic are just gates then the output pairs are going to match with the exception of the one with the permanent fault.  Next, we look at the c1, c2, c3 wires, suppose there exists a c1, c2, or c3 pair of mismatched wires.  This implies the 'good' half is excited and since the inputs to both sides are the same then both halves are excited.  This contradicts the initial mismatched assumption since this is a deadlock state, thus all c1 pairs are equal (with the exception of that downstream of the fault pair).  Then all c2 pairs and c3 pairs are equal as well. \newline
\end{proof}
\newline
The results are summarized in the following table.  
This leads us to make the restart rule to decide which c-element should restart.  \newline
\includegraphics[width=\textwidth]{table1}
A configuration that allows the correct variable to restart is as follows. \newline
\includegraphics[width=\textwidth]{restartscheme}
%Since we added new circuit components we make sure faults in these new wires do not affect the original circuit operation.  
We analyze when a fault occurs on c3 and evaluate whether our restart scheme work correctly.  First when a deadlock occurs on c3, the only mismatched wires are c3 and the w wires following it.  Thus all restart units in others wires have $c_{i-1}^A$ XOR $c_{i-1}^B=0$ and the restart timer is off.  The restart timer is potentially on for c3 and the wire w.  Without loss of assumption, assume that $c3^A$ has the permanent fault.  

%but lemma 1 doesn't say ALL branches can be reached.  So we need to show at least somewhat regularly that a wire must be changed.  <- I think the Meng paper can show this <- must be an initial criteria I include ie live circuit
%maybe lemma 4 needs to be reworded as no matter how many times a wire fluctuates c2=/= and c3=/= cannot happen at the same time <- I don't need an addendum for case 1 cuz it's true on all the wires
%when restarted, need to show that it 'saves' the circuit (ie the good half goes according to original) until the next deadlock

%my perm fault proof is a little broken right now :(
\end{document}